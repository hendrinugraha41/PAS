<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal Penilaian Akhir Semester</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
  <div id="app" class="max-w-6xl mx-auto"></div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbx7FQMcSkNEXPoD_7HYrkCUEnJDyKqr4TSKO4BwREuwxVCPzFwjd5SiLQf97k8gEuyZ/exec"; // ganti dengan URL Web App kamu

  const defaultConfig = {
    school_name: "SMP Negeri 18 Samarinda",
    portal_title: "Portal Penilaian Akhir Semester",
    semester_info: "Ujian Semester Ganjil Tahun Ajaran 2005/2006",
    accent_color: "#8b5cf6",
    button_color: "#10b981"
  };

  let allSubjects = [];
  let credentials = { username: "admin", password: "admin123" };
  let currentView = "home";
  let selectedGrade = null;
  let isLoggedIn = false;

  async function loadData() {
    const [subjectsRes, adminRes] = await Promise.all([
      fetch(API_URL + "?type=subjects"),
      fetch(API_URL + "?type=admin")
    ]);
    allSubjects = await subjectsRes.json();
    credentials = await adminRes.json();
  }

  async function saveSubjects() {
    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "subjects", data: allSubjects })
    });
  }

  async function saveCredentials() {
    await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ type: "admin", data: credentials })
    });
  }

  function render() {
    const app = document.getElementById("app");
    const cfg = defaultConfig;

    if (currentView === "home") {
      app.innerHTML = `
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-blue-600">${cfg.school_name}</h1>
          <h2 class="text-xl font-semibold text-gray-800">${cfg.portal_title}</h2>
          <p>${cfg.semester_info}</p>
        </div>
        <div class="grid md:grid-cols-3 gap-6 mb-8">
          ${["7","8","9"].map(g=>`
            <div class="bg-white rounded-xl p-6 shadow hover:shadow-lg cursor-pointer" onclick="showGrade('${g}')">
              <h3 class="text-xl font-bold text-blue-600 text-center">Kelas ${g}</h3>
              <p class="text-center text-gray-600">12 Mata Pelajaran</p>
            </div>`).join("")}
        </div>
        <div class="text-center">
          <button onclick="showLogin()" class="px-6 py-3 rounded-lg font-semibold text-white" style="background:${cfg.accent_color}">Admin</button>
        </div>`;
    }

    if (currentView === "grade") {
      const subjects = allSubjects.filter(s=>s.grade===selectedGrade);
      app.innerHTML = `
        <button onclick="backToHome()" class="mb-6 px-4 py-2 bg-white rounded-lg">‚Üê Kembali</button>
        <h2 class="text-center text-2xl font-bold text-blue-600 mb-4">Kelas ${selectedGrade}</h2>
        <div class="grid md:grid-cols-2 gap-4">
          ${subjects.map(s=>`
            <button class="p-4 rounded-lg text-left font-semibold text-white" 
              style="background:${s.enabled ? cfg.button_color : '#94a3b8'}; cursor:${s.enabled?'pointer':'not-allowed'};" 
              ${s.enabled ? `onclick="openLink('${s.form_link}')"` : ""}>
              üìù ${s.subject_name} ${s.enabled?"":"<span class='text-yellow-200 text-sm'>(Nonaktif)</span>"}
            </button>`).join("")}
        </div>`;
    }

    if (currentView === "login") {
      app.innerHTML = `
        <div class="max-w-md mx-auto bg-white rounded-xl p-8 shadow">
          <button onclick="backToHome()" class="mb-6 px-4 py-2 bg-gray-100 rounded-lg">‚Üê Kembali</button>
          <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">Login Admin</h2>
          <form onsubmit="handleLogin(event)">
            <input id="username" placeholder="Username" class="w-full p-3 border rounded mb-4" required>
            <input id="password" type="password" placeholder="Password" class="w-full p-3 border rounded mb-4" required>
            <div id="login-error" class="hidden text-red-600 mb-3 text-center"></div>
            <button class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold">Masuk</button>
          </form>
        </div>`;
    }

    if (currentView === "admin") {
      app.innerHTML = `
        <div class="flex justify-between mb-6">
          <button onclick="logout()" class="px-4 py-2 bg-white rounded-lg">‚Üê Logout</button>
          <button onclick="showSettings()" class="px-4 py-2 bg-purple-500 text-white rounded-lg">‚öôÔ∏è Pengaturan</button>
        </div>
        <h2 class="text-center text-2xl font-bold text-blue-600 mb-6">Panel Admin</h2>
        <div class="grid md:grid-cols-3 gap-6">
          ${["7","8","9"].map(g=>{
            const subs=allSubjects.filter(s=>s.grade===g);
            return `
              <div class="bg-white rounded-xl p-4 shadow">
                <h3 class="text-center font-bold text-blue-600 mb-3">Kelas ${g}</h3>
                ${subs.map(s=>`
                  <div class="p-2 mb-2 bg-gray-50 rounded">
                    <div class="flex justify-between items-center mb-1">
                      <span>${s.subject_name}</span>
                      <small>${s.enabled?"Aktif":"Nonaktif"}</small>
                    </div>
                    <button onclick="toggleEnabled('${s.grade}','${s.subject_name}')" class="text-sm px-2 py-1 bg-purple-400 text-white rounded">‚ö° Toggle</button>
                    <button onclick="editSubject('${s.grade}','${s.subject_name}')" class="text-sm px-2 py-1 bg-green-500 text-white rounded">‚úèÔ∏è Edit</button>
                  </div>`).join("")}
              </div>`;
          }).join("")}
        </div>`;
    }

    if (currentView === "settings") {
      app.innerHTML = `
        <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow">
          <button onclick="backToAdmin()" class="mb-6 px-4 py-2 bg-gray-100 rounded-lg">‚Üê Kembali</button>
          <h2 class="text-center text-xl font-bold text-blue-600 mb-4">Pengaturan Login</h2>
          <form onsubmit="updateCredentials(event)">
            <input id="new-username" value="${credentials.username}" class="w-full p-3 border rounded mb-4">
            <input id="new-password" type="password" value="${credentials.password}" class="w-full p-3 border rounded mb-4">
            <button class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold">üíæ Simpan</button>
          </form>
        </div>`;
    }
  }

  function showGrade(g){ selectedGrade=g; currentView="grade"; render(); }
  function backToHome(){ currentView="home"; render(); }
  function showLogin(){ currentView="login"; render(); }
  function logout(){ isLoggedIn=false; currentView="home"; render(); }
  function backToAdmin(){ currentView="admin"; render(); }
  function showSettings(){ currentView="settings"; render(); }
  function openLink(url){ if(url) window.open(url,"_blank"); }

  function handleLogin(e){
    e.preventDefault();
    const u=document.getElementById("username").value;
    const p=document.getElementById("password").value;
    if(u===credentials.username && p===credentials.password){
      isLoggedIn=true; currentView="admin"; render();
    } else {
      const err=document.getElementById("login-error");
      err.textContent="Username atau password salah!"; err.classList.remove("hidden");
    }
  }

  function toggleEnabled(grade,name){
    const s = allSubjects.find(x=>x.grade===grade && x.subject_name===name);
    if(!s)return;
    s.enabled=!s.enabled;
    saveSubjects();
    render();
  }

  function editSubject(grade,name){
    const s = allSubjects.find(x=>x.grade===grade && x.subject_name===name);
    const newName = prompt("Nama Mata Pelajaran:", s.subject_name);
    const newLink = prompt("Link Form:", s.form_link);
    if(newName!==null){ s.subject_name=newName; }
    if(newLink!==null){ s.form_link=newLink; }
    saveSubjects();
    render();
  }

  function updateCredentials(e){
    e.preventDefault();
    credentials.username=document.getElementById("new-username").value;
    credentials.password=document.getElementById("new-password").value;
    saveCredentials();
    currentView="admin"; render();
  }

  loadData().then(render);
  </script>
</body>
</html>
